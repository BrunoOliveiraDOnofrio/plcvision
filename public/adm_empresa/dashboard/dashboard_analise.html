<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório</title>
    <!-- Fonte google  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../css/fonts.css">
    <link rel="stylesheet" href="../../css/nav_side_bar.css">
    <link rel="stylesheet" href="../../css/dashboards/monitoramento_tempo_real.css">
    <link rel="stylesheet" href="../../css/dashboards/historico.css">
    <!-- Link dos icones - boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Nav Bar -->
    <header class="header-nav">
        <div class="menu-foto">
            <i id="hamb_menu" onclick="abrirSideBar()" class='bx bx-menu'></i>
            <div class="foto"></div>
            <div class="barra-sep"></div>
        </div>

        <div class="user-options">
            <span id="username">Usuário</span>
            <i onclick="menuCollapse()" class='bx bx-chevron-down'></i>
            <div id="div_menu" class="collapse-menu">
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Alertas</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <header class="header-nav header-nav-desk">
        <div class="menu-foto">
            <i id="hamb_menu" onclick="abrirSideBar()" class='bx bx-menu'></i>
            <div class="fotoEmpresa"></div>
            <span id="span_empresa" class="nome-empresa">Motorola</span>
            <div class="barra-sep"></div>
            <span id="span_endereco_empresa" class="endereco">Alameda Ferraz 456</span>
        </div>

        <div class="user-options">
            <div class="foto"></div>
            <span id="username">Usuário</span>
            <i onclick="menuCollapseDesk()" class='bx bx-chevron-down'></i>
            <div id="div_menu_desk" class="collapse-menu">
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Alertas</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Side bar  -->
    <nav id="nav_sidebar" class="sidebar sidebar-fechada">
        <div class="inicio">
            <ul>
             
                <li>
                    <a href=".././dashboard">
                        <i class='bx bx-timer'></i>
                    </a>
                </li>
                <li>
                    <a href=".././alertas">
                        <i class='bx bxs-bell-ring'></i>
                    </a>
                </li>
                <li>
                    <a href=".././plcs">
                        <i class='bx bx-desktop'></i>
                    </a>
                </li>
            </ul>
        </div>
        <div class="saida">
            <ul>
                <li>
                    <a href="#">
                        <i class='bx bx-exit'></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="main">
        <div class="content">
            <div class="header">
                <h1>Relatório</h1>
                <p>Histórico dos recursos</p>
                <div class="filtros-container">
                    <label for="ipt_dtInicial">Data Inicial:</label>
                    <input type="date" id="ipt_dtInicial">

                    <label for="ipt_dtFinal">Data Final:</label>
                    <input type="date" id="ipt_dtFinal">

                    <label for="filtro-fabrica">Fábrica:</label>
                    <select id="filtro-fabrica">
                        <option value="todas">Todas</option>
                        <option value="und1">Volkswagen - Und. 1</option>
                        <option value="und2">Volkswagen - Und. 2</option>
                    </select>

                    <label for="filtro-setor">Setor:</label>
                    <select id="filtro-setor">
                        <option value="todos">Todos</option>
                        <option value="pintura">Pintura</option>
                        <option value="solda">Solda</option>
                        <option value="montagem">Montagem</option>
                    </select>

                    <button id="aplicar-filtros" onclick="filtrar()">Filtrar</button>
                </div>

                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-cpu" style="color: orange;">85%</div>
                        <div class="kpi-label">CPU Média</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-ram" style="color: blue;">78.2%</div>
                        <div class="kpi-label">RAM Média</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-temperatura" style="color: blue;">70.2%</div>
                        <div class="kpi-label">Temperatura Média</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-picos">5</div>
                        <div class="kpi-label">Picos de CPU</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-alertas">2</div>
                        <div class="kpi-label">Máquinas em Alerta</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-rede">5.45GB</div>
                        <div class="kpi-label">Tráfego de Rede</div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>CPU média de todos PLCs</h3>
                        <div class="chart-container">
                            <canvas id="cpuMediaGrafico"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Uso de RAM por máquina</h3>
                        <div class="chart-container">
                            <canvas id="ramGrafico"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Temperatura média</h3>
                        <div class="chart-container">
                            <canvas id="temperaturaGrafico"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Tráfego de rede médio</h3>
                        <div class="chart-container">
                            <canvas id="redeGrafico"></canvas>
                        </div>
                    </div>
                </div>

                <div class="tabela-container">
                    <div class="chart-header">Horários de Pico CPU por PLC</div>
                    <table id="cpu-table">
                        <thead>
                            <tr>
                                <th>Máquina ID</th>
                                <th>Horários de Pico</th>
                                <th>CPU Média (%)</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>

                <div class="tabela-container">
                    <div class="chart-header">Horários de Pico RAM por PLC</div>
                    <table id="ram-table">
                        <thead>
                            <tr>
                                <th>Máquina ID</th>
                                <th>Horários de Pico</th>
                                <th>RAM Média (%)</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>

                <div class="tabela-container">
                    <h2>Outliers por Data</h2>
                    <table id="outliers-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Data</th>
                                <th>Total Outliers</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script src="../../js/nav_sidebar.js"></script>


        <script>
            const horariosDisponiveis = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];

            const plcs = [
                { id: 'PLC 4', cpu: 41.2, ram: 62.1, temperatura: 65.3, rede: 2.5, horario: '07:00', data: '2025-04-16', fabrica: 'und1', setor: 'pintura', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 4', cpu: 43.5, ram: 64.2, temperatura: 66.1, rede: 2.7, horario: '08:00', data: '2025-04-16', fabrica: 'und1', setor: 'pintura', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 4', cpu: 87.1, ram: 88.9, temperatura: 76.3, rede: 3.8, horario: '09:00', data: '2025-04-16', fabrica: 'und1', setor: 'pintura', picos_cpu: ['09:00'], picos_ram: ['09:00'] },
                { id: 'PLC 4', cpu: 80.2, ram: 82.5, temperatura: 74.1, rede: 3.4, horario: '10:00', data: '2025-04-16', fabrica: 'und1', setor: 'pintura', picos_cpu: [], picos_ram: [] },

                { id: 'PLC 5', cpu: 35.1, ram: 58.5, temperatura: 64.7, rede: 3.3, horario: '07:00', data: '2025-04-16', fabrica: 'und2', setor: 'solda', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 5', cpu: 36.7, ram: 59.8, temperatura: 65.4, rede: 3.5, horario: '08:00', data: '2025-04-16', fabrica: 'und2', setor: 'solda', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 5', cpu: 88.4, ram: 80.1, temperatura: 77.8, rede: 4.9, horario: '09:00', data: '2025-04-16', fabrica: 'und2', setor: 'solda', picos_cpu: ['09:00'], picos_ram: ['09:00'] },
                { id: 'PLC 5', cpu: 84.1, ram: 78.6, temperatura: 75.4, rede: 4.6, horario: '10:00', data: '2025-04-16', fabrica: 'und2', setor: 'solda', picos_cpu: [], picos_ram: [] },

                { id: 'PLC 6', cpu: 50.2, ram: 69.1, temperatura: 69.8, rede: 5.1, horario: '07:00', data: '2025-04-16', fabrica: 'und1', setor: 'montagem', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 6', cpu: 51.8, ram: 70.2, temperatura: 70.5, rede: 5.3, horario: '08:00', data: '2025-04-16', fabrica: 'und1', setor: 'montagem', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 6', cpu: 95.2, ram: 91.7, temperatura: 82.3, rede: 6.5, horario: '09:00', data: '2025-04-16', fabrica: 'und1', setor: 'montagem', picos_cpu: ['09:00'], picos_ram: ['09:00'] },
                { id: 'PLC 6', cpu: 90.3, ram: 89.2, temperatura: 80.9, rede: 6.2, horario: '10:00', data: '2025-04-16', fabrica: 'und1', setor: 'montagem', picos_cpu: [], picos_ram: [] },

                { id: 'PLC 7', cpu: 38.7, ram: 60.5, temperatura: 65.1, rede: 2.8, horario: '07:00', data: '2025-04-16', fabrica: 'und2', setor: 'montagem', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 7', cpu: 40.1, ram: 62.2, temperatura: 66.4, rede: 3.0, horario: '08:00', data: '2025-04-16', fabrica: 'und2', setor: 'montagem', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 7', cpu: 86.8, ram: 84.9, temperatura: 75.6, rede: 5.4, horario: '09:00', data: '2025-04-16', fabrica: 'und2', setor: 'montagem', picos_cpu: ['09:00'], picos_ram: ['09:00'] },

                { id: 'PLC 8', cpu: 44.3, ram: 65.4, temperatura: 67.2, rede: 2.6, horario: '07:00', data: '2025-04-16', fabrica: 'und1', setor: 'pintura', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 8', cpu: 45.7, ram: 66.8, temperatura: 68.1, rede: 2.9, horario: '08:00', data: '2025-04-16', fabrica: 'und1', setor: 'pintura', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 8', cpu: 89.2, ram: 86.7, temperatura: 78.5, rede: 4.2, horario: '09:00', data: '2025-04-16', fabrica: 'und1', setor: 'pintura', picos_cpu: ['09:00'], picos_ram: ['09:00'] },

                { id: 'PLC 4', cpu: 42.8, ram: 63.0, temperatura: 65.7, rede: 2.6, horario: '08:00', data: '2025-04-17', fabrica: 'und1', setor: 'pintura', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 5', cpu: 37.2, ram: 59.5, temperatura: 65.1, rede: 3.4, horario: '08:00', data: '2025-04-17', fabrica: 'und2', setor: 'solda', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 6', cpu: 53.1, ram: 71.5, temperatura: 71.2, rede: 5.4, horario: '08:00', data: '2025-04-17', fabrica: 'und1', setor: 'montagem', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 7', cpu: 41.9, ram: 62.9, temperatura: 67.0, rede: 3.2, horario: '08:00', data: '2025-04-17', fabrica: 'und2', setor: 'montagem', picos_cpu: [], picos_ram: [] },

                { id: 'PLC 4', cpu: 46.0, ram: 64.5, temperatura: 67.1, rede: 2.7, horario: '08:00', data: '2025-04-18', fabrica: 'und1', setor: 'pintura', picos_cpu: [], picos_ram: [] },
                { id: 'PLC 5', cpu: 91.8, ram: 85.3, temperatura: 78.0, rede: 5.0, horario: '09:00', data: '2025-04-18', fabrica: 'und2', setor: 'solda', picos_cpu: ['09:00'], picos_ram: ['09:00'] },
            ];

            const outlier = [
                { data: '2025-04-16', total: 13 },
                { data: '2025-04-17', total: 9 },
                { data: '2025-04-06', total: 12 },
                { data: '2025-04-21', total: 11 },
                { data: '2025-04-26', total: 11 },
                { data: '2025-04-23', total: 10 },
                { data: '2025-04-09', total: 8 },
                { data: '2025-04-18', total: 7 },
                { data: '2025-04-19', total: 7 },
                { data: '2025-04-22', total: 6 },
                { data: '2025-04-04', total: 5 }
            ];

            let graficoCPU = null;
            let graficoRede = null;
            let graficoCPUmedia = null;
            let graficoRAM = null;
            let graficoTemp = null;

            // Verifica se a data Inicial e a data Final são do mesmo dia
            // Se sim, aplica o filtro de um único dia
            function mesmoDia(dataInicio, dataFim) {
                return dataInicio.getFullYear() == dataFim.getFullYear() &&
                    dataInicio.getMonth() == dataFim.getMonth() &&
                    dataInicio.getDate() == dataFim.getDate();
            }

            function filtrar() {
                const dataInicial = document.getElementById('ipt_dtInicial').value;
                const dataFinal = document.getElementById('ipt_dtFinal').value;
                const filtroFabrica = document.getElementById('filtro-fabrica').value;
                const filtroSetor = document.getElementById('filtro-setor').value;

                aplicarFiltros(dataInicial, dataFinal, filtroFabrica, filtroSetor);
            }

            function aplicarFiltros(dataInicial, dataFinal, filtroFabrica, filtroSetor) {
                const dtInicial = new Date(dataInicial);
                const dtFinal = new Date(dataFinal);
                console.log(dtInicial, dtFinal);

                const filtroDiario = mesmoDia(dtInicial, dtFinal);

                const plcsFiltrados = [];
                for (let i = 0; i < plcs.length; i++) {
                    const plcAtual = plcs[i];
                    const dataPlcAtual = new Date(plcAtual.data);

                    if ((filtroFabrica == 'todas' || filtroFabrica == plcAtual.fabrica) && (filtroSetor == 'todos' || filtroSetor == plcAtual.setor) && (dataPlcAtual >= dtInicial && dataPlcAtual <= dtFinal)) {
                        plcsFiltrados.push(plcAtual);
                    }
                }

                const outliersFiltrados = [];
                for (let i = 0; i < outlier.length; i++) {
                    const outlierAtual = outlier[i];
                    const dataOutlierAtual = new Date(outlierAtual.data);

                    if (dataOutlierAtual >= dtInicial && dataOutlierAtual <= dtFinal) {
                        outliersFiltrados.push(outlierAtual);
                    }
                }

                const dadosFiltrados = {
                    plcs: plcsFiltrados,
                    outliers: outliersFiltrados,
                    filtroDiario: filtroDiario
                };

                console.log(dadosFiltrados);

                plotarKPI(dadosFiltrados);
                plotarGrafico(dadosFiltrados);
                plotarTabela(dadosFiltrados);
            }

            function plotarKPI(dadosFiltrados) {
                if (dadosFiltrados.plcs.length == 0) {
                    document.getElementById('kpi-cpu').textContent = "0%";
                    document.getElementById('kpi-ram').textContent = "0%";
                    document.getElementById('kpi-temperatura').textContent = "0%";
                    document.getElementById('kpi-picos').textContent = "0";
                    document.getElementById('kpi-alertas').textContent = "0";
                    document.getElementById('kpi-rede').textContent = "0GB";
                    return;
                }

                // Fazer a média das KPIs
                let cpuTotal = 0;
                let ramTotal = 0;
                let tempTotal = 0;
                let redeTotal = 0;

                for (let i = 0; i < dadosFiltrados.plcs.length; i++) {
                    const plcAtual = dadosFiltrados.plcs[i];
                    cpuTotal += plcAtual.cpu;
                    ramTotal += plcAtual.ram;
                    tempTotal += plcAtual.temperatura;
                    redeTotal += plcAtual.rede;
                }

                const cpuMedia = cpuTotal / dadosFiltrados.plcs.length;
                const ramMedia = ramTotal / dadosFiltrados.plcs.length;
                const tempMedia = tempTotal / dadosFiltrados.plcs.length;

                // const horariosComPico = new Set();
                // plcs.forEach(plc => {
                //     plc.picos_cpu.forEach(horario => {
                //         horariosComPico.add(`${plc.data} ${horario}`);
                //     });
                // });

                // // Número de picos distintos
                // console.log('Horários com pico', horariosComPico);
                // const numeroDePicos = horariosComPico.size;

                const plcMap = {};

                for (let i = 0; i < dadosFiltrados.plcs.length; i++) {
                    const plcAtual = dadosFiltrados.plcs[i];

                    if (!plcMap[plcAtual.id]) {
                        plcMap[plcAtual.id] = {
                            cpuTot: 0,
                            ramTot: 0,
                            cont: 0
                        };
                    }

                    plcMap[plcAtual.id].cpuTot += plcAtual.cpu;
                    plcMap[plcAtual.id].ramTot += plcAtual.ram;
                    plcMap[plcAtual.id].cont++;
                }

                const plcsEmAlerta = [];

                console.log('Plc MAP', plcMap);

                for (const id in plcMap) {
                    const dados = plcMap[id];
                    const mediaCpu = dados.cpuTot / dados.cont;
                    const mediaRam = dados.ramTot / dados.cont;
                    if (mediaCpu > 80 || mediaRam > 80) {
                        plcsEmAlerta.push(id);
                    }
                }

                console.log('Plc em alerta', plcsEmAlerta);
                const maquinasAlerta = plcsEmAlerta.length;

                document.getElementById('kpi-cpu').textContent = cpuMedia.toFixed(2) + '%';
                document.getElementById('kpi-cpu').style.color = cpuMedia > 90 ? 'red' : (cpuMedia > 80 ? 'orange' : 'blue');

                document.getElementById('kpi-ram').textContent = ramMedia.toFixed(2) + '%';
                document.getElementById('kpi-ram').style.color = ramMedia > 90 ? 'red' : (ramMedia > 80 ? 'orange' : 'blue');

                document.getElementById('kpi-temperatura').textContent = tempMedia.toFixed(2) + '%';
                document.getElementById('kpi-temperatura').style.color = tempMedia > 80 ? 'red' : (tempMedia > 70 ? 'orange' : 'blue');

                document.getElementById('kpi-alertas').innerHTML = maquinasAlerta;
                document.getElementById('kpi-rede').textContent = redeTotal.toFixed(2) + 'GB';
            }

            function plotarGrafico(dadosFiltrados) {
                if (dadosFiltrados.plcs.length == 0) {
                    graficoRede.destroy();
                    graficoCPUmedia.destroy();
                    graficoRAM.destroy();
                    graficoTemp.destroy();
                    return;
                }

                const filtroDiario = dadosFiltrados.filtroDiario;
                const ctx = {
                    rede: document.getElementById('redeGrafico').getContext('2d'),
                    cpuMedia: document.getElementById('cpuMediaGrafico').getContext('2d'),
                    ram: document.getElementById('ramGrafico').getContext('2d'),
                    temperatura: document.getElementById('temperaturaGrafico').getContext('2d')
                };

                let labels = [];
                let dadosCpu = [];
                let dadosRam = [];
                let dadosTemp = [];
                let dadosRede = [];


                // Se a pessoa escolher apenas um dia, o eixo X mostra os horários
                if (filtroDiario) {
                    // Construção de um JSON para criar um objeto com os horários e as médias de cada um deles
                    const registrosPorHorario = {};

                    for (let i = 0; i < dadosFiltrados.plcs.length; i++) {
                        const plcAtual = dadosFiltrados.plcs[i];
                        const horario = plcAtual.horario;

                        // Se o horário não existir, cria um novo objeto horario com tudo zerado
                        if (!registrosPorHorario[horario]) {
                            registrosPorHorario[horario] = {
                                cont: 0,
                                somaCPU: 0,
                                somaRAM: 0,
                                somaTemp: 0,
                                somaRede: 0
                            };
                        }

                        registrosPorHorario[horario].cont++;
                        registrosPorHorario[horario].somaCPU += plcAtual.cpu;
                        registrosPorHorario[horario].somaRAM += plcAtual.ram;
                        registrosPorHorario[horario].somaTemp += plcAtual.temperatura;
                        registrosPorHorario[horario].somaRede += plcAtual.rede;
                    }

                    for (let horario in registrosPorHorario) {
                        labels.push(horario);
                    }

                    // Não sei fazer ordenação com strings, como você descobriu???
                    // Ordena os horários em ordem crescente = labels["08:00", "09:00", n...]
                    labels.sort();

                    dadosCpu = [];
                    dadosRam = [];
                    dadosTemp = [];
                    dadosRede = [];


                    // Faz a média de cada um dos elementos dos horários e coloca no array de dados
                    for (let i = 0; i < labels.length; i++) {
                        const horario = labels[i];
                        dadosCpu.push(registrosPorHorario[horario].somaCPU / registrosPorHorario[horario].cont);
                        dadosRam.push(registrosPorHorario[horario].somaRAM / registrosPorHorario[horario].cont);
                        dadosTemp.push(registrosPorHorario[horario].somaTemp / registrosPorHorario[horario].cont);
                        dadosRede.push(registrosPorHorario[horario].somaRede);
                    }
                } else {
                    // Se a pessoa escolher mais de um dia, o eixo X mostra os dias
                    const registrosPorDia = {};

                    for (let i = 0; i < dadosFiltrados.plcs.length; i++) {
                        const plc = dadosFiltrados.plcs[i];
                        const data = plc.data;

                        if (!registrosPorDia[data]) {
                            registrosPorDia[data] = {
                                cont: 0,
                                somaCPU: 0,
                                somaRAM: 0,
                                somaTemp: 0,
                                somaRede: 0
                            };
                        }

                        registrosPorDia[data].cont++;
                        registrosPorDia[data].somaCPU += plc.cpu;
                        registrosPorDia[data].somaRAM += plc.ram;
                        registrosPorDia[data].somaTemp += plc.temperatura;
                        registrosPorDia[data].somaRede += plc.rede;
                    }

                    // Organiza datas em ordem cronológica
                    for (let dia in registrosPorDia) {
                        labels.push(dia);
                    }


                    // Exatamente, ainda não aprendi a fazer uma ordenação com strings
                    labels.sort();

                    // Aqui foi GPT total, desculpa
                    // Formata datas DD/MM/YYYY
                    const labelsFormatados = [];
                    for (let i = 0; i < labels.length; i++) {
                        const data = labels[i];
                        const [ano, mes, dia] = data.split('-');
                        labelsFormatados.push(`${dia}/${mes}/${ano}`);
                    }

                    dadosCpu = [];
                    dadosRam = [];
                    dadosTemp = [];
                    dadosRede = [];

                    for (let i = 0; i < labels.length; i++) {
                        const data = labels[i];
                        dadosCpu.push(registrosPorDia[data].somaCPU / registrosPorDia[data].cont);
                        dadosRam.push(registrosPorDia[data].somaRAM / registrosPorDia[data].cont);
                        dadosTemp.push(registrosPorDia[data].somaTemp / registrosPorDia[data].cont);
                        dadosRede.push(registrosPorDia[data].somaRede);
                    }

                    labels = labelsFormatados;
                }


                // labels = eixo x, dadosAlgumaCoisa = eixo y
                // ctx = aonde o gráfico vai ser plotado no front
                // filtroDiario = se o gráfico é diário ou não. Caso diario, o eixo X é horário, se não o eixo X é a data
                plotarGraficoRede(ctx.rede, labels, dadosRede, filtroDiario);
                plotarGraficoCPUMedia(ctx.cpuMedia, labels, dadosCpu, filtroDiario);
                plotarGraficoRAM(ctx.ram, labels, dadosRam, filtroDiario);
                plotarGraficoTemp(ctx.temperatura, labels, dadosTemp, filtroDiario);
            }

            function plotarGraficoRede(ctx, labels, dados, filtroDiario) {
                if (graficoRede) {
                    graficoRede.destroy();
                }

                graficoRede = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tráfego de Rede (GB)',
                            data: dados,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Tráfego (GB)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: filtroDiario ? 'Horário' : 'Dias'
                                }
                            }
                        }
                    }
                });
            }

            function plotarGraficoCPUMedia(ctx, labels, dados, filtroDiario) {
                if (graficoCPUmedia) {
                    graficoCPUmedia.destroy();
                }

                graficoCPUmedia = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'CPU Média (%)',
                            data: dados,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'CPU (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: filtroDiario ? 'Horário' : 'Dias'
                                }
                            }
                        }
                    }
                });
            }

            function plotarGraficoRAM(ctx, labels, dados, filtroDiario) {
                if (graficoRAM) {
                    graficoRAM.destroy();
                }

                graficoRAM = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'RAM Média (%)',
                            data: dados,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'RAM (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: filtroDiario ? 'Horário' : 'Dias'
                                }
                            }
                        }
                    }
                });
            }

            function plotarGraficoTemp(ctx, labels, dados, filtroDiario) {
                if (graficoTemp) {
                    graficoTemp.destroy();
                }

                graficoTemp = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Temperatura Média (%)',
                            data: dados,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Temperatura (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: filtroDiario ? 'Horário' : 'Dias'
                                }
                            }
                        }
                    }
                });
            }

            function plotarTabela(dadosFiltrados) {
                plotarTabelaCPU(dadosFiltrados);
                plotarTabelaRAM(dadosFiltrados);
                plotarTabelaOutlier(dadosFiltrados);
            }

            function plotarTabelaCPU(dadosFiltrados) {
                const tabelaCPU = document.getElementById('cpu-table').getElementsByTagName('tbody')[0];
                tabelaCPU.innerHTML = ''; // Limpar tabela

                // Agrupar dados por máquina
                const dadosPorMaquina = {};

                for (let i = 0; i < dadosFiltrados.plcs.length; i++) {
                    const maquinaAtual = dadosFiltrados.plcs[i];

                    if (!dadosPorMaquina[maquinaAtual.id]) {
                        dadosPorMaquina[maquinaAtual.id] = {
                            id: maquinaAtual.id,
                            somaCPU: 0,
                            quantidade: 0,
                            horariosPico: []
                        };
                    }

                    dadosPorMaquina[maquinaAtual.id].somaCPU += maquinaAtual.cpu;
                    dadosPorMaquina[maquinaAtual.id].quantidade++;

                    // Adicionar horários de pico de CPU
                    if (maquinaAtual.picos_cpu && maquinaAtual.picos_cpu.length > 0) {
                        for (let j = 0; j < maquinaAtual.picos_cpu.length; j++) {
                            const horarioPico = maquinaAtual.picos_cpu[j];
                            if (!dadosPorMaquina[maquinaAtual.id].horariosPico.includes(horarioPico)) {
                                dadosPorMaquina[maquinaAtual.id].horariosPico.push(horarioPico);
                            }
                        }
                    }
                }

                // Preencher a tabela
                for (const idMaquina in dadosPorMaquina) {
                    const dadosMaquina = dadosPorMaquina[idMaquina];

                    const linha = tabelaCPU.insertRow();
                    const celulaId = linha.insertCell(0);
                    const celulaPicos = linha.insertCell(1);
                    const celulaMediaCPU = linha.insertCell(2);

                    const mediaCPU = dadosMaquina.somaCPU / dadosMaquina.quantidade;

                    celulaId.textContent = dadosMaquina.id;

                    if (dadosMaquina.horariosPico.length > 0) {
                        celulaPicos.textContent = dadosMaquina.horariosPico.join(', ');
                    } else {
                        celulaPicos.textContent = '-';
                    }

                    celulaMediaCPU.textContent = mediaCPU.toFixed(1) + '%';

                    if (mediaCPU > 90) {
                        celulaId.style.color = 'red';
                        celulaPicos.style.color = 'red';
                        celulaMediaCPU.style.color = 'red';
                    } else if (mediaCPU > 80) {
                        celulaId.style.color = 'orange';
                        celulaPicos.style.color = 'orange';
                        celulaMediaCPU.style.color = 'orange';
                    }
                }

                contarEExibirPicos(dadosFiltrados);
            }

            function contarEExibirPicos(dadosFiltrados) {
                const horariosComPico = new Set();

                for (let i = 0; i < dadosFiltrados.plcs.length; i++) {
                    const maquina = dadosFiltrados.plcs[i];
                    if (maquina.picos_cpu && maquina.picos_cpu.length > 0) {
                        for (let j = 0; j < maquina.picos_cpu.length; j++) {
                            const horario = maquina.picos_cpu[j];
                            horariosComPico.add(`${maquina.data} ${horario}`);
                        }
                    }
                }

                const totalPicos = horariosComPico.size;

                document.getElementById('kpi-picos').textContent = totalPicos;
            }




            function plotarTabelaRAM(dadosFiltrados) {
                const ramTable = document.getElementById('ram-table').getElementsByTagName('tbody')[0];
                ramTable.innerHTML = ''; // Limpar tabela

                // Agrupar dados por máquina
                const plcsDados = {};

                for (let i = 0; i < dadosFiltrados.plcs.length; i++) {
                    const plc = dadosFiltrados.plcs[i];

                    if (!plcsDados[plc.id]) {
                        plcsDados[plc.id] = {
                            id: plc.id,
                            ramTotal: 0,
                            cont: 0,
                            picos: []
                        };
                    }

                    plcsDados[plc.id].ramTotal += plc.ram;
                    plcsDados[plc.id].cont++;

                    // Adicionar picos de RAM
                    if (plc.picos_ram && plc.picos_ram.length > 0) {
                        for (let j = 0; j < plc.picos_ram.length; j++) {
                            const pico = plc.picos_ram[j];
                            // Verifica se o pico já existe na lista
                            let picoExiste = false;
                            for (let k = 0; k < plcsDados[plc.id].picos.length; k++) {
                                if (plcsDados[plc.id].picos[k] === pico) {
                                    picoExiste = true;
                                    break;
                                }
                            }
                            if (!picoExiste) {
                                plcsDados[plc.id].picos.push(pico);
                            }
                        }
                    }
                }

                // Calcular média de RAM e formatar para a tabela
                const plcsIds = Object.keys(plcsDados);
                for (let i = 0; i < plcsIds.length; i++) {
                    const plcId = plcsIds[i];
                    const plc = plcsDados[plcId];

                    const row = ramTable.insertRow();
                    const cellId = row.insertCell(0);
                    const cellPicos = row.insertCell(1);
                    const cellRamMedia = row.insertCell(2);

                    const ramMedia = plc.ramTotal / plc.cont;

                    cellId.textContent = plc.id;

                    // Junta os picos com vírgula ou coloca traço se vazio
                    if (plc.picos.length > 0) {
                        let picoTexto = '';
                        for (let j = 0; j < plc.picos.length; j++) {
                            if (j > 0) {
                                picoTexto += ', ';
                            }
                            picoTexto += plc.picos[j];
                        }
                        cellPicos.textContent = picoTexto;
                    } else {
                        cellPicos.textContent = '-';
                    }

                    cellRamMedia.textContent = ramMedia.toFixed(1) + '%';

                    // Estilizar conforme valor
                    if (ramMedia > 90) {
                        cellId.style.color = 'red';
                        cellPicos.style.color = 'red';
                        cellRamMedia.style.color = 'red';
                    } else if (ramMedia > 80) {
                        cellId.style.color = 'orange';
                        cellPicos.style.color = 'orange';
                        cellRamMedia.style.color = 'orange';
                    }
                }
            }

            function plotarTabelaOutlier(dadosFiltrados) {
                const corpoTabela = document.getElementById('outliers-table').getElementsByTagName('tbody')[0];
                corpoTabela.innerHTML = ''; // Limpar tabela

                for (let i = 0; i < dadosFiltrados.outliers.length - 1; i++) {
                    for (let j = i + 1; j < dadosFiltrados.outliers.length; j++) {
                        if (dadosFiltrados.outliers[j].total > dadosFiltrados.outliers[i].total) {
                            const temp = dadosFiltrados.outliers[i];
                            dadosFiltrados.outliers[i] = dadosFiltrados.outliers[j];
                            dadosFiltrados.outliers[j] = temp;
                        }
                    }
                }

                for (let i = 0; i < dadosFiltrados.outliers.length; i++) {
                    const item = dadosFiltrados.outliers[i];
                    const row = corpoTabela.insertRow();
                    const cellIndex = row.insertCell(0);
                    const cellData = row.insertCell(1);
                    const cellTotal = row.insertCell(2);

                    cellIndex.textContent = i + 1;

                    // Formatar data para o padrão brasileiro
                    const dateParts = item.data.split('-');
                    const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    cellData.textContent = formattedDate;

                    cellTotal.textContent = item.total;

                    // Estilizar conforme quantidade
                    if (item.total > 10) {
                        cellTotal.style.color = 'red';
                    } else if (item.total > 7) {
                        cellTotal.style.color = 'orange';
                    }
                }
            }

            window.addEventListener('load', function () {
                const hoje = new Date();
                const dataHoje = hoje.toISOString().split('T')[0]; // Formato YYYY-MM-DD

                document.getElementById('ipt_dtInicial').value = dataHoje;
                document.getElementById('ipt_dtFinal').value = dataHoje;

                aplicarFiltros(dataHoje, dataHoje, 'todas', 'todos');
            });
        </script>
</body>

</html>