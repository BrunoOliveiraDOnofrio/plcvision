<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../../css/fonts.css">
    <link rel="stylesheet" href="../../../css/nav_side_bar.css">
    <link rel="stylesheet" href="../../../css/StyleCadastroUsuario.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="../../../js/nav_sidebar.js"></script>
    <link rel="shortcut icon" href="../../assets/imgs/logo-aba_white.png">
    <title>PLCVision - Alterar Usuário</title>
</head>

<body>

    <header class="header-nav">
        <div class="menu-foto">
            <i id="hamb_menu" onclick="abrirSideBar()" class='bx bx-menu'></i>
            <div class="foto"></div>
            <div class="barra-sep"></div>
        </div>

        <div class="user-options">
            <span id="username">Usuário</span>
            <i onclick="menuCollapse()" class='bx bx-chevron-down'></i>
            <div id="div_menu" class="collapse-menu">
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Alertas</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <header class="header-nav header-nav-desk">
        <div class="menu-foto">
            <i id="hamb_menu" onclick="abrirSideBar()" class='bx bx-menu'></i>
            <div class="fotoEmpresa"></div>
            <span id="span_empresa" class="nome-empresa">Motorola</span>
            <div class="barra-sep"></div>
            <span id="span_endereco_empresa" class="endereco">Alameda Ferraz 456</span>
        </div>

        <div class="user-options">
            <div class="foto"></div>
            <span id="username">Usuário</span>
            <i onclick="menuCollapseDesk()" class='bx bx-chevron-down'></i>
            <div id="div_menu_desk" class="collapse-menu">
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Alertas</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Side bar  -->

    <nav id="nav_sidebar" class="sidebar sidebar-fechada">
        <div class="inicio">
            <ul>
                <li>
                    <a href="../.././consumidores">
                        <i class='bx bx-group'></i>
                    </a>
                </li>
                <li>
                    <a href="../.././alertas">
                        <i class='bx bxs-bell-ring'></i>
                    </a>
                </li>
                <li>
                    <a href="../.././fabricas">
                        <i class='bx bxs-factory'></i>
                    </a>
                </li>
                <li>
                    <a href="../.././setores">
                        <i class='bx bx-category-alt'></i>

                    </a>
                </li>
                <li>
                    <a href="../.././usuarios">
                        <i class='bx bxs-user'></i>
                    </a>
                </li>
                <li>
                    <a href="../.././plcs">
                        <i class='bx bx-desktop'></i>
                    </a>
                </li>
            </ul>
        </div>
        <div class="saida">
            <ul>
                <li>
                    <a href="#">
                        <i class='bx bx-exit'></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    <!-- Cadastro do Usuário -->

    <div class="main">
        <div class="content">
            <div class="title">
                <h1>Atualizar Usuário:</h1>
            </div>
            <div class="box-register">
                <div class="box-field">
                    <div class="left-field">
                        <div class="field">
                            <span>Nome:</span>
                            <input type="text" id="ipt_nome">
                        </div>
                        <div class="field">
                            <span>E-mail:</span>
                            <input type="text" id="ipt_email">
                        </div>
                        <div class="field">
                            <span>Celular:</span>
                            <input type="text" id="ipt_celular">
                        </div>
                    </div>
                    <div class="right-field">
                        <div class="field">
                            <span>Nível:</span>
                            <input type="text" id="ipt_nivel">
                        </div>
                        <div class="field">
                            <span>Setor:</span>
                            <input type="text" id="ipt_setor">
                        </div>
                        <div class="field">
                            <span>Cargo:</span>
                            <input type="text" id="ipt_cargo">
                        </div>
                    </div>
                    </div>
                    <div class="buttons">
                        <button class="exit-button" onclick="voltar()">Cancelar</button>
                        <button class="register-button" onclick="atualizarUsuario()">Atualizar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>

<script>

    console.log(localStorage.getItem('id'))

    function obterDadosUsuario() {
    const usuarioId = localStorage.getItem('id');
    console.log(usuarioId);
    // Fazer a requisição para buscar os dados do usuario
    fetch(`/usuario/atualizarCampo/${usuarioId}`)
        .then(response => {
            return response.json();
        })
        .then(data => {
            console.log(data)
            // Preencher os campos com os dados retornados
            document.getElementById('ipt_nome').value = data.nome;
            document.getElementById('ipt_email').value = data.email;
            document.getElementById('ipt_celular').value = data.telCelular;
            document.getElementById('ipt_nivel').value = data.nivel;
            document.getElementById('ipt_setor').value = data.setor;
            document.getElementById('ipt_cargo').value = data.cargo;
        })
        .catch(error => {
            console.error('Erro ao buscar dados da fábrica:', error);
        });
    }
    obterDadosUsuario()

    async function atualizarUsuario() {

        
        // const params = new URLSearchParams(window.location.search);
        // const usuarioId = params.get('id');
        const usuarioId = localStorage.getItem('id');

        console.log("ID do usuário:", usuarioId);

        if (!usuarioId) {
            alert("ID do usuário não encontrado.");
            return;
        }

        const nome = document.getElementById('ipt_nome').value;
        const email = document.getElementById('ipt_email').value;
        const celular = document.getElementById('ipt_celular').value;
        const nivel = document.getElementById('ipt_nivel').value;
        const setor = document.getElementById('ipt_setor').value;
        const cargo = document.getElementById('ipt_cargo').value;

        const dados = {
            nome: nome,
            email: email,
            celular: celular,
            nivel: nivel,
            setor: setor,
            cargo: cargo,
        };
        console.log("Dados enviados:", dados);

        try {
            const response = await fetch(`/usuario/atualizar/${usuarioId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dados)
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Usuário atualizado com sucesso:', data);
                alert("Usuário atualizado com sucesso!");
                window.location.href = "../";
            } else {
                console.error('Erro ao atualizar usuário:', response.statusText);
                alert("Erro ao atualizar usuário.");
            }
        } catch (error) {
            console.error('Erro ao atualizar usuário:', error);
            alert("Erro ao conectar ao servidor.");
        }
    }

    function voltar(){
        window.location.href = `../`;
    }
</script>