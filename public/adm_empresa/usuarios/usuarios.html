<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLCVision - Lista Usuários</title>
    <link rel="stylesheet" href="../../css/fonts.css">
    <link rel="stylesheet" href="../../css/nav_side_bar.css">
    <link rel="stylesheet" href="../../css/corpo_consumidoras.css">
    <link rel="shortcut icon" href="../../assets/imgs/logo-aba_white.png">
    <!-- Link dos icones - boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

</head>

<body>
    <!-- Nav Bar -->
    <header class="header-nav">
        <div class="menu-foto">
            <i id="hamb_menu" onclick="abrirSideBar()" class='bx bx-menu'></i>
            <div class="foto"></div>
            <div class="barra-sep"></div>
        </div>

        <div class="user-options">
            <span id="username">Usuário</span>
            <i onclick="menuCollapse()" class='bx bx-chevron-down'></i>
            <div id="div_menu" class="collapse-menu">
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Alertas</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <header class="header-nav header-nav-desk">
        <div class="menu-foto">
            <i id="hamb_menu" onclick="abrirSideBar()" class='bx bx-menu'></i>
            <div class="fotoEmpresa"></div>
            <span id="span_empresa" class="nome-empresa">Motorola</span>
            <div class="barra-sep"></div>
            <span id="span_endereco_empresa" class="endereco">Alameda Ferraz 456</span>
        </div>

        <div class="user-options">
            <div class="foto"></div>
            <span id="username">Usuário</span>
            <i onclick="menuCollapseDesk()" class='bx bx-chevron-down'></i>
            <div id="div_menu_desk" class="collapse-menu">
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Alertas</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Side bar  -->

    <nav id="nav_sidebar" class="sidebar sidebar-fechada">
        <div class="inicio">
            <ul>
                <li>
                    <a href="./consumidores">
                        <i class='bx bx-group'></i>
                    </a>
                </li>
                <li>
                    <a href="./alertas">
                        <i class='bx bxs-bell-ring' ></i>
                    </a>
                </li>
                <li>
                    <a href="./fabricas">
                        <i class='bx bxs-factory'></i>
                    </a>
                </li>
                <li>
                    <a href="./setores">
                <i class='bx bx-category-alt'></i>
                        
                    </a>
                </li>
                <li>
                    <a href="./usuarios">
                        <i class='bx bxs-user'></i>
                    </a>
                </li>
                <li>
                    <a href="./plcs">
                        <i class='bx bx-desktop'></i>
                    </a>
                </li>
            </ul>
        </div>
        <div class="saida">
            <ul>
                <li>
                    <a href="#">
                        <i class='bx bx-exit'></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="main">
        <div class="container">
            <h1>Lista de Funciónarios cadastradas</h1>
            <button class="btn-adicionar" onclick="adicionar()">Adicionar</button>
            <div class="container-tabela">
                <table class="tabela">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Setor</th>
                            <th>Cargo</th>
                            <th class="viz_rem_colum">Vizualização</th>
                            <th class="viz_rem_colum">Remover</th>
                        </tr>
                    </thead>
                    <tbody id="tbody_usuarios">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal" id="modalVisualizar">
            <div class="content_modal">
                <div class="modal-header">
                    <h2>Detalhes do Funcionário</h2>
                    <button class="fecha">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="detalhe-item">
                        <span class="detalhe-label">Nome:</span>
                        <span id="detalheNome"></span>
                    </div>
                    <div class="detalhe-item">
                        <span class="detalhe-label">E-mail:</span>
                        <span id="detalheEmail"></span>
                    </div>
                    <div class="detalhe-item">
                        <span class="detalhe-label">Telefone:</span>
                        <span id="detalheTelefone"></span>
                    </div>
                    <div class="detalhe-item">
                        <span class="detalhe-label">Setor:</span>
                        <span id="detalheSetor"></span>
                    </div>
                    <div class="detalhe-item">
                        <span class="detalhe-label">Nível:</span>
                        <span id="detalheNivel"></span>
                    </div>
                    <div class="detalhe-item">
                        <span class="detalhe-label">Cargo:</span>
                        <span id="detalheCargo"></span>
                    </div>
                </div>
                <div class="modal-btn-fechar">
                    <button class="btn-fechar">Fechar</button>
                </div>
                <div class="modal-btn-fechar">
                    <button class="btn-editar">Editar</button>
                </div>
            </div>
        </div>
</body>

<script src="../../js/nav_sidebar.js"></script>
<script src="../../js/usuarios/listar.js"></script>

</html>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const empresaId = sessionStorage.EMPRESA_ID;
        const tbody = document.getElementById('tbody_usuarios');
        async function carregarUsuarios() {
            try {
                let response;
                if (!empresaId) {
                    console.log("NAO TA VINDO EMPRESA.");
                    response = await fetch('/usuario');
                } else {
                    console.log(`Empresa ${empresaId}.`);
                    response = await fetch(`/usuario/lista/${empresaId}`);
                }

                if (!response.ok) {
                    throw new Error("Erro ao buscar usuários.");
                }

                const usuarios = await response.json();

                tbody.innerHTML = "";

                usuarios.forEach(usuario => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${usuario.id}</td>
                    <td>${usuario.nome}</td>
                    <td>${usuario.setor}</td>
                    <td>${usuario.cargo}</td>
                    <td class="central_viz_rem">
                        <button class="btn-visualizar" data-id="${usuario.id}">
                            <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                <path stroke="currentColor" stroke-width="2" d="M21 12c0 1.2-4.03 6-9 6s-9-4.8-9-6c0-1.2 4.03-6 9-6s9 4.8 9 6Z"/>
                                <path stroke="currentColor" stroke-width="2" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                            </svg>
                        </button>
                    </td>
                    <td class="central_viz_rem">
                        <button class="btn-remover" data-id="${usuario.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);">
                                <path d="M12 4.998c-1.836 0-3.356.389-4.617.971L3.707 2.293 2.293 3.707l3.315 3.315c-2.613 1.952-3.543 4.618-3.557 4.66l-.105.316.105.316C2.073 12.382 4.367 19 12 19c1.835 0 3.354-.389 4.615-.971l3.678 3.678 1.414-1.414-3.317-3.317c2.614-1.952 3.545-4.618 3.559-4.66l.105-.316-.105-.316c-.022-.068-2.316-6.686-9.949-6.686zM12.043 7H12a5 5 0 0 1 5 5 4.894 4.894 0 0 1-.852 2.734l-.721-.721A3.919 3.919 0 0 0 16 11.999c0-.474-.099-.925-.255-1.349A.985.985 0 0 1 15 11a1 1 0 0 1-1-1c0-.439.288-.802.682-.936A3.965 3.965 0 0 0 12 7.999c-.735 0-1.419.218-2.015.572l-.72-.72C10.053 7.326 10.982 7 12 7h-.043L12 6.998l.043.002zm-7.969 4.999c.103-.235.274-.586.521-.989l5.867 5.867c-4.213-.647-5.939-3.842-6.388-4.878zm9.247 4.908-7.48-7.48a8.146 8.146 0 0 1 1.188-.984l8.055 8.055a8.835 8.835 0 0 1-1.763.409z"></path>
                            </svg>
                        </button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });

                const btnVisualizar = document.querySelectorAll('.btn-visualizar');
                btnVisualizar.forEach(btn => {
                    btn.addEventListener('click', async function () {
                        const id = this.getAttribute('data-id');
                        await visualizarUsuario(id);
                    });
                });
                const btnRemover = document.querySelectorAll('.btn-remover');
                btnRemover.forEach(btn => {
                    btn.addEventListener('click', async function () {
                        const id = this.getAttribute('data-id');
                        const confirmar = confirm("Tem certeza que deseja remover este usuário?");
                        if (confirmar) {
                            try {
                                const response = await fetch(`/usuario/${id}`, {
                                    method: "DELETE"
                                });
                                if (response.ok) {
                                    alert("Usuário removido com sucesso!");
                                    carregarUsuarios();
                                } else {
                                    alert("Erro ao remover usuário.");
                                }
                            } catch (error) {
                                console.error("Erro ao remover usuário:", error);
                                alert("Erro ao remover usuário.");
                            }
                        }
                    });
                });
            } catch (error) {
                console.error("Erro ao carregar usuários:", error);
                alert("Erro ao carregar usuários.");
            }
        }

        async function visualizarUsuario(id) {
            try {
                const response = await fetch(`/usuario/${id}`);
                if (!response.ok) {
                    throw new Error("Erro ao buscar detalhes do usuário.");
                }
                const usuario = await response.json();
                document.getElementById('detalheNome').textContent = usuario.nome;
                document.getElementById('detalheEmail').textContent = usuario.email;
                document.getElementById('detalheTelefone').textContent = usuario.telCelular;
                document.getElementById('detalheSetor').textContent = usuario.setor;
                document.getElementById('detalheNivel').textContent = usuario.nivel;
                document.getElementById('detalheCargo').textContent = usuario.cargo;

                const modal = document.getElementById('modalVisualizar');
                modal.style.display = 'flex';

                const btnFechar = modal.querySelector('.btn-fechar');
                btnFechar.addEventListener('click', function () {
                    modal.style.display = 'none';
                });

                const btnEditar = modal.querySelector('.btn-editar');
                btnEditar.addEventListener('click', function () {
                    window.location.href = `./editar.html?id=${id}`;
                });
            } catch (error) {
                console.error("Erro ao buscar detalhes do usuário:", error);
                alert("Erro ao buscar detalhes do usuário.");
            }
        }
        carregarUsuarios();
    });
</script>