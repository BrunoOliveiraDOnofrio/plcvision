<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório</title>
    <!-- Fonte google  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../css/fonts.css">
    <link rel="stylesheet" href="../../css/nav_side_bar.css">
    <link rel="stylesheet" href="../../css/dashboards/monitoramento_tempo_real.css">
    <link rel="stylesheet" href="../../css/dashboards/outlier.css">
    <!-- Link dos icones - boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Link do Papa Parse para tranformar csv em json -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Nav Bar -->
    <header class="header-nav">
        <div class="menu-foto">
            <i id="hamb_menu" onclick="abrirSideBar()" class='bx bx-menu'></i>
            <div class="foto"></div>
            <div class="barra-sep"></div>
        </div>

        <div class="user-options">
            <span id="username">Usuário</span>
            <i onclick="menuCollapse()" class='bx bx-chevron-down'></i>
            <div id="div_menu" class="collapse-menu">
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Alertas</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <header class="header-nav header-nav-desk">
        <div class="menu-foto">
            <i id="hamb_menu" onclick="abrirSideBar()" class='bx bx-menu'></i>
            <div class="fotoEmpresa"></div>
            <span id="span_empresa" class="nome-empresa">Motorola</span>
            <div class="barra-sep"></div>
            <span id="span_endereco_empresa" class="endereco">Alameda Ferraz 456</span>
        </div>

        <div class="user-options">
            <div class="foto"></div>
            <span id="username">Usuário</span>
            <i onclick="menuCollapseDesk()" class='bx bx-chevron-down'></i>
            <div id="div_menu_desk" class="collapse-menu">
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Alertas</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Side bar  -->
    <nav id="nav_sidebar" class="sidebar sidebar-fechada">
        <div class="inicio">
            <ul>

                <li>
                    <a href=".././dashboard">
                        <i class='bx bx-timer'></i>
                    </a>
                </li>
                <li>
                    <a href=".././alertas">
                        <i class='bx bxs-bell-ring'></i>
                    </a>
                </li>
                <li>
                    <a href=".././plcs">
                        <i class='bx bx-desktop'></i>
                    </a>
                </li>
            </ul>
        </div>
        <div class="saida">
            <ul>
                <li>
                    <a href="#">
                        <i class='bx bx-exit'></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="main">
        <div class="content">
            <h1 class="dashboard-title">Processos</h1>

            <div class="filters">
                <div class="filter-group">
                    <label for="empresa">Empresa</label>
                    <select id="empresa" class="filter-select">
                        <option value="">Todas as empresas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="fabrica">Fábrica</label>
                    <select id="fabrica" class="filter-select">
                        <option value="">Todas as fábricas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="data-inicial">Data Inicial</label>
                    <input type="date" id="data-inicial" class="filter-select">
                </div>
                <div class="filter-group">
                    <label for="data-final">Data Final</label>
                    <input type="date" id="data-final" class="filter-select">
                </div>
                <button id="btn-aplicar-filtros" class="filter-select" style="background-color: #24284B;">Aplicar
                    Filtros
                </button>
            </div>

            <table id="tabelaAnomalias">
                <thead>
                    <tr>
                        <th>Modelo</th>
                        <th>Quantidade de Alerta(s) Relacionado(s)</th>
                        <th>Status de Criticidade</th>
                        <th>Detalhe</th>
                    </tr>
                </thead>
                <tbody id="corpoDaTabela">

                </tbody>
            </table>

            <div id="janelaDetalhes" style="display: none;">
                <div id="conteudoDetalhes">

                </div>
            </div>
        </div>
    </div>
    <script src="../../js/nav_sidebar.js"></script>
</body>

</html>

<script>
    let empresas = [];
    let fabricanteId = sessionStorage.getItem('EMPRESA_ID');

    // carregar informações quando a página é carregada
    document.addEventListener('DOMContentLoaded', function () {
        carregarEmpresas();
        configurarFiltros();
    });

    // Carregar lista das empresas no filtro
    async function carregarEmpresas() {
        const response = await fetch(`/api/fabricante/${fabricanteId}/empresas_consumidoras`);
        empresas = await response.json();

        // joga as empresas no select e no option
        const selectEmpresa = document.getElementById('empresa');
        selectEmpresa.innerHTML = '<option value="">Todas as empresas</option>';
        empresas.forEach(empresa => {
            selectEmpresa.innerHTML += `<option value="${empresa.id}">${empresa.razao_social}</option>`;
        });

        mostrarEmpresas();
    }

    // aplica evento nos filtros
    // e carrega as fábricas quando a empresa é selecionada
    function configurarFiltros() {
        document.getElementById('empresa').onchange = carregarFabricas;
        document.getElementById('btn-aplicar-filtros').onclick = aplicarFiltros;
    }

    // carrega fabrica quandoa a empresa é selecionada
    async function carregarFabricas() {
        const empresaId = document.getElementById('empresa').value;
        const selectFabrica = document.getElementById('fabrica');

        selectFabrica.innerHTML = '<option value="">Todas as fábricas</option>';

        if (empresaId) {
            const response = await fetch(`/api/empresa_consumidora/${empresaId}/fabrica_setores`);
            const dados = await response.json();

            const fabricas = [];
            const idsFabricas = [];
            dados.forEach(item => {
                if (!idsFabricas.includes(item.fabrica_id)) {
                    fabricas.push({ id: item.fabrica_id, nome: item.fabrica_nome });
                    idsFabricas.push(item.fabrica_id);
                }
            });

            fabricas.forEach(fabrica => {
                selectFabrica.innerHTML += `<option value="${fabrica.id}">${fabrica.nome}</option>`;
            });
        }
    }

    // Filtros
    async function aplicarFiltros() {
        const empresaId = document.getElementById('empresa').value;
        const fabricaId = document.getElementById('fabrica').value;

        // caso não filtro selecionado da empresa, volta para a lista das empresas clientes
        if (!empresaId && !fabricaId) {
            mostrarEmpresas();
            return;
        }

        // Se tem fábrica selecionada, busca PLCs da fábrica
        if (fabricaId) {
            const response = await fetch(`/api/fabrica/${fabricaId}/plcs`);
            const plcs = await response.json();
            mostrarPlcs(plcs);
        }
        // Se tem só empresa selecionada, busca PLCs da empresa
        else if (empresaId) {
            const response = await fetch(`/api/fabricante/${fabricanteId}/plcs?empresaId=${empresaId}`);
            const plcs = await response.json();
            mostrarPlcs(plcs);
        }
    }

    // Mostrar tabela de empresas
    function mostrarEmpresas() {
        const tabela = document.getElementById('corpoDaTabela');
        tabela.innerHTML = '';

        empresas.forEach((empresa, index) => {
            const status = empresa.quantidade_alertas > 10 ? 'Alerta' :
                empresa.quantidade_alertas > 5 ? 'Atenção' : 'Normal';

            tabela.innerHTML += `
                    <tr>
                        <td>${empresa.razao_social}</td>
                        <td>${empresa.quantidade_alertas}</td>
                        <td>${status}</td>
                        <td>
                            <button onclick="verDetalhesEmpresa(${empresa.id}, ${index})">
                                Detalhes
                            </button>
                        </td>
                    </tr>
                    <tr id="detalhes-${index}" style="display: none;">
                        <td colspan="4">Carregando...</td>
                    </tr>
                `;
        });
    }

    // Mostrar tabela de PLCs
    function mostrarPlcs(plcs) {
        const tabela = document.getElementById('corpoDaTabela');
        tabela.innerHTML = '';

        plcs.forEach((plc, index) => {
            const status = plc.quantidade_alertas > 10 ? 'Alerta' :
                plc.quantidade_alertas > 5 ? 'Atenção' : 'Normal';

            tabela.innerHTML += `
                    <tr>
                        <td>${plc.modelo}</td>
                        <td>${plc.quantidade_alertas}</td>
                        <td>${status}</td>
                        <td>
                            <button onclick="verDetalhesPlc(${plc.id}, '${plc.modelo}', ${index})">
                                Detalhes
                            </button>
                        </td>
                    </tr>
                    <tr id="detalhes-${index}" style="display: none;">
                        <td colspan="4">Carregando...</td>
                    </tr>
                `;
        });
    }

    // Ver detalhes de uma empresa
    async function verDetalhesEmpresa(empresaId, index) {
        const linha = document.getElementById(`detalhes-${index}`);

        if (linha.style.display === 'table-row') {
            linha.style.display = 'none';
            return;
        }

        linha.style.display = 'table-row';

        const response = await fetch(`/api/empresa_consumidora/${empresaId}/fabricas_mais_alertas`);
        const fabricas = await response.json();

        let html = '<h4>Fábricas com mais alertas:</h4><ul>';
        fabricas.forEach(fabrica => {
            html += `<li><b>${fabrica.fabrica_nome}</b>: ${fabrica.quantidade_alertas} alertas</li>`;
        });
        html += '</ul>';

        linha.querySelector('td').innerHTML = html;
    }

    // Ver detalhes de um PLC
    async function verDetalhesPlc(plcId, modelo, index) {
        const linha = document.getElementById(`detalhes-${index}`);

        if (linha.style.display === 'table-row') {
            linha.style.display = 'none';
            return;
        }

        linha.style.display = 'table-row';

        const response = await fetch(`/api/plc/${plcId}/setores`);
        const setores = await response.json();

        let html = `<h4>Setores do modelo ${modelo}:</h4><ul>`;
        setores.forEach(setor => {
            html += `<li><b>${setor.setor_nome}</b>: ${setor.quantidade_alertas} alertas</li>`;
        });
        html += '</ul>';


        // add gráfico na web
        const graficoId = `grafico-${plcId}-${Date.now()}`;
        html += `<div style="width: 400px; height: 200px; margin: 20px auto;">
                        <canvas id="${graficoId}"></canvas>
                     </div>`;

        linha.querySelector('td').innerHTML = html;

        setTimeout(() => criarGrafico(graficoId, setores), 100);
    }

    // gráfico barras
    function criarGrafico(graficoId, setores) {
        const canvas = document.getElementById(graficoId);

        const nomes = setores.map(s => s.setor_nome);
        const valores = setores.map(s => s.quantidade_alertas);

        new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: nomes,
                datasets: [{
                    label: 'Alertas por Setor',
                    data: valores,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
</script>